# HRL-XF 启发式参数文档

> **版本**：1.0  
> **更新日期**：2025年12月15日  
> **用途**：记录 HRL-XF 代理中所有可调节的启发式参数

---

## 概述

HRL-XF 代理采用分层架构（L1-L4），每层都包含启发式参数。这些参数在没有神经网络训练时控制代理行为，也作为神经网络训练的基线参考。

---

## 1. L1 安全层参数 (`l1_safety.py`)

### 1.1 类初始化参数

| 参数 | 类型 | 默认值 | 文件位置 | 用途 |
|------|------|--------|----------|------|
| `horizon` | int | 40 | L229 | 规划视界（天数），决定 Q_safe 和 time_mask 的长度 |
| `reserve` | float | 1000.0 | L230 | 安全储备金，计算可用资金时预留的应急资金 |
| `min_tradable_qty` | float | 1.0 | L231 | 最小可交易量阈值，用于生成时间掩码 |

**详细说明**：

#### `reserve` (安全储备金)
```python
B_free = B_current - reserve - total_payables
```
- **场景**：余额 10,000，应付款 5,000，储备金 1,000 → 可用资金 4,000
- **影响**：值越大越保守，防止资金链断裂；值太小可能破产

#### `min_tradable_qty` (最小可交易量)
```python
time_mask[delta] = 0.0 if Q_safe[delta] >= min_tradable_qty else -inf
```
- **场景**：Q_safe[5] = 0.5 < 1.0 → time_mask[5] = -inf（不可选）
- **影响**：值越大排除更多天数，交货选择更保守

---

### 1.2 基准动作硬编码参数 (`_compute_baseline` 方法)

| 参数 | 值 | 文件位置 | 公式 | 用途 |
|------|-----|----------|------|------|
| 买入价格系数 | 0.95 | L388 | `p_base = market_price * 0.95` | 买方基准出价比市场价低 5% |
| 卖出价格系数 | 1.05 | L413 | `p_base = market_price * 1.05` | 卖方基准要价比市场价高 5% |
| 数量保守系数 | 0.5 | L384, L410 | `q_base = Q_safe[δ] / 2` | 基准数量取安全量的一半 |
| 默认交货日 | 1 | L377, L409 | `best_delta = 1` | 默认选择明天交货 |
| 最小数量 | 1.0 | L385, L410 | `q_base = max(1.0, q_base)` | 保证最低交易量 |
| 默认输入价格 | 10.0 | L374 | `get_price(input_product, 10.0)` | 市场价不可用时的回退值 |
| 默认输出价格 | 20.0 | L395 | `get_price(output_product, 20.0)` | 市场价不可用时的回退值 |

**详细说明**：

#### 买入价格系数 `0.95`
- **含义**：买方初始出价 = 市场价 × 0.95
- **场景**：市场价 100 → 出价 95
- **调优**：成交率低时提高到 0.98；利润薄时降低到 0.92

#### 卖出价格系数 `1.05`
- **含义**：卖方初始要价 = 市场价 × 1.05
- **场景**：市场价 100 → 要价 105
- **调优**：成交率低时降低到 1.02；利润薄时提高到 1.08

#### 数量保守系数 `0.5`
- **含义**：只使用一半的安全容量
- **场景**：最多能买 20 → 实际只买 10
- **调优**：激进策略可提高到 0.7；保守策略降低到 0.3

---

## 2. L2 战略层参数 (`l2_manager.py`)

### 2.1 类初始化参数

| 参数 | 类型 | 默认值 | 文件位置 | 用途 |
|------|------|--------|----------|------|
| `horizon` | int | 40 | L122 | 规划视界 |
| `base_price_margin` | float | 0.1 | L123 | 价格边际，控制买卖价差 |

**详细说明**：

#### `base_price_margin` (价格边际)
```python
P_buy = spot_price * (1 - base_price_margin * urgency)
P_sell = spot_price * (1 + base_price_margin * urgency)
```
- **场景**：边际 0.1，紧迫性 1.0 → 买入目标 = 市场价 × 0.9
- **影响**：边际越大利润空间越大，但成交难度增加

---

### 2.2 目标生成硬编码参数 (`HeuristicL2Manager.compute` 方法)

| 参数 | 值 | 文件位置 | 公式 | 用途 |
|------|-----|----------|------|------|
| 紧迫性衰减 | 0.2 | L159 | `urgency = 1.0 - bucket_idx * 0.2` | 控制各时间桶的紧迫程度 |
| 后期阈值 | 0.8 | L175 | `if step_progress > 0.8` | 触发清仓策略的时间点 |
| 前期阈值 | 0.2 | L179 | `elif step_progress < 0.2` | 触发建库策略的时间点 |
| 后期买入系数 | 0.5 | L177 | `Q_buy *= 0.5` | 后期减少采购 |
| 后期卖出系数 | 2.0 | L178 | `Q_sell *= 2.0` | 后期加速清库 |
| 前期买入系数 | 1.5 | L181 | `Q_buy *= 1.5` | 前期增加采购 |
| 前期卖出系数 | 0.5 | L182 | `Q_sell *= 0.5` | 前期惜售 |
| 生产线归一化 | 10 | L151 | `n_lines = x_static[4] * 10` | 反归一化生产线数量 |
| 价格归一化 | 50 | L152-153 | `spot_price * 50` | 反归一化价格 |
| 库存归一化 | 100 | L156, L167 | `inventory * 100` | 反归一化库存 |

**详细说明**：

#### 紧迫性衰减 `0.2`
```python
# 各桶紧迫性：
bucket 0 (紧急): urgency = 1.0
bucket 1 (短期): urgency = 0.8
bucket 2 (中期): urgency = 0.6
bucket 3 (长期): urgency = 0.4
```
- **影响**：衰减越快，长期目标越保守

#### 阶段阈值 (`0.2` / `0.8`)
- **场景**（100 天仿真）：
  - 第 1-20 天：建库期（多买少卖）
  - 第 21-80 天：正常运营
  - 第 81-100 天：清仓期（少买多卖）
- **调优**：后期阈值降低可更早开始清仓

---

## 3. L3 执行层参数 (`l3_executor.py`)

### 3.1 类初始化参数

| 参数 | 类型 | 默认值 | 文件位置 | 用途 |
|------|------|--------|----------|------|
| `horizon` | int | 40 | L76 | 规划视界 |
| `price_adjustment` | float | 0.05 | L77 | 价格调整幅度（预留参数） |
| `qty_adjustment` | float | 0.1 | L78 | 数量调整幅度 |

---

### 3.2 让步策略硬编码参数 (`HeuristicL3Executor.compute` 方法)

| 参数 | 值 | 文件位置 | 公式 | 用途 |
|------|-----|----------|------|------|
| 每轮让步率 | 0.02 | L108, L113 | `concession = n_rounds * 0.02` | 每轮谈判让步 2% |
| 最大让步上限 | 0.1 | L108, L113 | `min(n_rounds * 0.02, 0.1)` | 总让步不超过 10% |

**详细说明**：

#### 让步策略
```python
concession = min(n_rounds * 0.02, 0.1)

# 买方行为
delta_p = p_base * concession       # 愿意提高出价
delta_q = -q_base * 0.1 * (1-concession)  # 减少需求

# 卖方行为  
delta_p = -p_base * concession      # 愿意降低要价
delta_q = q_base * 0.1 * concession # 增加供应
```

- **场景**：
  - 第 1 轮：让步 2%
  - 第 3 轮：让步 6%
  - 第 5+ 轮：让步 10%（达到上限）
- **调优**：成交率低时增加让步率；利润薄时降低上限

---

## 4. L4 协调层参数 (`l4_coordinator.py`)

### 4.1 启发式协调器参数

| 参数 | 类型 | 默认值 | 文件位置 | 用途 |
|------|------|--------|----------|------|
| `horizon` | int | 40 | L70 | 规划视界 |
| `conflict_threshold` | int | 3 | L71 | 时间差小于此值视为冲突 |

**详细说明**：

#### `conflict_threshold` (冲突阈值)
- **含义**：两个谈判的交货时间差 ≤ 3 天时视为冲突
- **场景**：谈判 A 交货日 5，谈判 B 交货日 7 → 冲突（差值 2 < 3）
- **影响**：值越大检测到更多冲突，协调更保守

---

### 4.2 神经网络参数（用于训练）

| 参数 | 类型 | 默认值 | 文件位置 | 用途 |
|------|------|--------|----------|------|
| `d_model` | int | 64 | L179 | Transformer 隐藏维度 |
| `n_heads` | int | 4 | L180 | 注意力头数 |
| `thread_feat_dim` | int | 24 | L182 | 线程显式特征维度（不再使用 L3 隐状态） |
| `global_feat_dim` | int | 30 | L183 | 全局上下文特征维度 |

> 说明：当前 L4 输入语义已调整为 `thread_feat_set + global_feat`，不再依赖 L3 的 `hidden_state/latent`，以便启发式教师与神经 L4 共享同一输入分布。

---

## 5. StateBuilder 参数 (`state_builder.py`)

### 5.1 归一化参数

| 参数 | 类型 | 默认值 | 文件位置 | 用途 |
|------|------|--------|----------|------|
| `horizon` | int | 40 | L97 | 规划视界，决定 X_temporal 形状 |
| `max_price` | float | 50.0 | L100 | 最大价格，用于归一化 |
| `initial_balance` | float | None→10000 | L98, L127 | 初始资金，用于归一化余额 |
| `max_inventory` | float | None→n_lines*n_steps | L99, L132 | 最大库存（经济容量），用于归一化库存 |

### 5.2 硬编码归一化系数

| 参数 | 值 | 文件位置 | 公式 | 用途 |
|------|-----|----------|------|------|
| 余额归一化范围 | [0, 2] | L212 | `clip(wallet/initial, 0, 2)` | 余额可达初始值 2 倍 |
| 库存归一化范围 | [0, 1] | L213-214 | `clip(inv/max_inv, 0, 1)` | 库存不超过最大值 |
| 生产线最大值 | 10 | L216 | `clip(n_lines/10, 0, 1)` | 假设最多 10 条线 |
| 价格归一化范围 | [0, 2] | L218-219 | `clip(price/max_price, 0, 2)` | 价格可达预设 2 倍 |
| 默认输入价格 | 10.0 | L198 | - | 价格不可用时的回退值 |
| 默认输出价格 | 20.0 | L199 | - | 价格不可用时的回退值 |

---

## 6. Agent 层参数 (`agent.py`)

### 6.1 接受报价容差

| 参数 | 值 | 文件位置 | 公式 | 用途 |
|------|-----|----------|------|------|
| 买方价格容差 | 1.1 | L264 | `price > P_buy * 1.1` | 买入价最多超目标 10% |
| 卖方价格容差 | 0.9 | L269 | `price < P_sell * 0.9` | 卖出价最少为目标 90% |

**详细说明**：

```python
# 买方判断是否接受
if price > bucket_goal["P_buy"] * 1.1:  # 价格超目标 10% 以上
    return False  # 拒绝

# 卖方判断是否接受
if price < bucket_goal["P_sell"] * 0.9:  # 价格低于目标 10% 以上
    return False  # 拒绝
```

---

## 7. Rewards 参数 (`rewards.py`)

### 7.1 RewardConfig 参数

| 参数 | 类型 | 默认值 | 用途 |
|------|------|--------|------|
| `gamma` | float | 0.98 | 折扣因子，用于势能奖励 |
| `lambda_liquidity` | float | 0.1 | 流动性奖励权重 |
| `lambda_risk` | float | 0.5 | 风险惩罚权重 |
| `lambda_intrinsic` | float | 0.1 | 内在奖励权重 |
| `lambda_time` | float | 0.05 | 时间惩罚权重 |
| `min_balance_ratio` | float | 0.1 | 最小余额比例（低于此触发惩罚） |
| `min_inventory_ratio` | float | -0.2 | 最小库存比例（允许小幅负库存） |
| `max_reward` | float | 100.0 | 奖励裁剪上限 |
| `min_reward` | float | -100.0 | 奖励裁剪下限 |

---

## 8. 参数调优指南

### 8.1 常见问题与解决方案

| 问题现象 | 可能原因 | 调整建议 |
|---------|---------|---------|
| 成交率太低 | 价格系数太激进 | L1 买入 0.95→0.98，卖出 1.05→1.02 |
| 利润太薄 | 价格边际太小 | L2 base_price_margin 0.1→0.15 |
| 后期库存积压 | 清仓太晚 | L2 后期阈值 0.8→0.7 |
| 资金经常紧张 | 储备金不足 | L1 reserve 1000→2000 |
| 谈判轮次太多 | 让步太慢 | L3 每轮让步 0.02→0.03 |
| 爆仓频繁 | 买入太激进 | L1 数量系数 0.5→0.3 |

### 8.2 激进 vs 保守配置

**激进配置**（追求高利润，接受高风险）：
```python
L1:
  reserve = 500.0
  买入价格系数 = 0.92
  卖出价格系数 = 1.08
  数量系数 = 0.7

L2:
  base_price_margin = 0.15
  后期阈值 = 0.85

L3:
  每轮让步率 = 0.015
  最大让步上限 = 0.08
```

**保守配置**（追求稳定，牺牲利润）：
```python
L1:
  reserve = 2000.0
  买入价格系数 = 0.98
  卖出价格系数 = 1.02
  数量系数 = 0.3

L2:
  base_price_margin = 0.05
  后期阈值 = 0.7

L3:
  每轮让步率 = 0.03
  最大让步上限 = 0.15
```

---

## 10. 训练配置参数 (`training.py`)

### 10.1 TrainConfig 参数

| 分类 | 参数 | 类型 | 默认值 | 用途 |
|------|------|------|--------|------|
| **通用** | `seed` | int | 42 | 随机种子 |
| **通用** | `device` | str | "cuda"/"cpu" | 训练设备 |
| **L2 训练** | `l2_lr` | float | 3e-4 | L2 学习率 |
| **L2 训练** | `l2_batch_size` | int | 64 | L2 批次大小 |
| **L2 训练** | `l2_epochs` | int | 50 | L2 训练轮数 |
| **L3 训练** | `l3_lr` | float | 1e-4 | L3 学习率 |
| **L3 训练** | `l3_batch_size` | int | 32 | L3 批次大小 |
| **L3 训练** | `l3_epochs` | int | 100 | L3 训练轮数 |
| **PPO** | `ppo_clip` | float | 0.2 | PPO 裁剪系数 |
| **PPO** | `ppo_epochs` | int | 10 | 每次更新的 PPO 轮数 |
| **PPO** | `gamma` | float | 0.98 | 折扣因子 |
| **PPO** | `gae_lambda` | float | 0.95 | GAE λ 参数 |
| **AWR** | `awr_beta` | float | 1.0 | AWR 温度系数 |
| **AWR** | `awr_clip` | float | 20.0 | AWR 优势裁剪上限 |
| **正则化** | `grad_clip` | float | 0.5 | 梯度裁剪阈值 |
| **正则化** | `weight_decay` | float | 1e-4 | 权重衰减 |
| **保存** | `save_every` | int | 10 | 每 N 轮保存检查点 |
| **保存** | `log_every` | int | 1 | 每 N 轮记录日志 |

### 10.2 数据集参数

| 参数 | 类型 | 默认值 | 文件位置 | 用途 |
|------|------|--------|----------|------|
| `max_history_len` | int | 20 | L98 | L3 谈判历史最大长度 |
| `capacity` | int | 10000 | L437 | 经验回放池容量 |

---

## 11. 参数索引（按文件）

### l1_safety.py
- L193: `reserve = 1000.0`
- L229-231: `horizon=40, reserve=1000.0, min_tradable_qty=1.0`
- L374, L395: 默认价格 `10.0`, `20.0`
- L377, L409: 默认交货日 `1`
- L384, L410: 数量系数 `/2`
- L388: 买入价格 `*0.95`
- L413: 卖出价格 `*1.05`

### l2_manager.py
- L122-123: `horizon=40, base_price_margin=0.1`
- L159: 紧迫性衰减 `*0.2`
- L175, L179: 阶段阈值 `0.8`, `0.2`
- L177-178: 后期系数 `*0.5`, `*2.0`
- L181-182: 前期系数 `*1.5`, `*0.5`

### l3_executor.py
- L76-78: `horizon=40, price_adjustment=0.05, qty_adjustment=0.1`
- L108, L113: 让步率 `*0.02`, 上限 `0.1`

### l4_coordinator.py
- L70-71: `horizon=40, conflict_threshold=3`

### state_builder.py
- L97-100: `horizon=40, max_price=50.0`
- L127, L132: 默认值 `10000.0`, `100.0`
- L216: 生产线最大 `10.0`

### agent.py
- L264, L269: 价格容差 `*1.1`, `*0.9`
- L67-72: `mode="heuristic", horizon=40, debug=False`

### rewards.py
- L96-108: RewardConfig 所有参数

### training.py
- L42-71: TrainConfig 所有参数
- L98: `max_history_len=20`
- L437: `capacity=10000`

---

*本文档应随代码更新同步维护*
